<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GameController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">TimeGuess</a> &gt; <a href="index.source.html" class="el_package">at.qe.timeguess.controllers</a> &gt; <span class="el_source">GameController.java</span></div><h1>GameController.java</h1><pre class="source lang-java linenums">package at.qe.timeguess.controllers;

import at.qe.timeguess.dto.Mapping;
import at.qe.timeguess.dto.*;
import at.qe.timeguess.gamelogic.Dice;
import at.qe.timeguess.gamelogic.Game;
import at.qe.timeguess.gamelogic.Game.GameAlreadyRunningException;
import at.qe.timeguess.gamelogic.Game.GameCreationException;
import at.qe.timeguess.gamelogic.Team;
import at.qe.timeguess.model.Category;
import at.qe.timeguess.model.User;
import at.qe.timeguess.repositories.CategoryRepository;
import at.qe.timeguess.services.LobbyService;
import at.qe.timeguess.services.LobbyService.GameNotFoundException;
import at.qe.timeguess.services.RaspberryService.RaspberryNotFoundException;
import at.qe.timeguess.services.UserService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;

import java.util.Collection;
import java.util.LinkedList;
import java.util.List;

/**
 * Class that controls creating, viewing and deleting games via REST.
 *
 *
 */
@RequestMapping(&quot;/games&quot;)
@RestController
<span class="fc" id="L34">public class GameController {</span>

	@Autowired
	private LobbyService lobbyService;

	@Autowired
	private UserService userService;

	@Autowired
	private CategoryRepository categoryRepository;

	/**
	 * Method that creates a game from a HTTP request.
	 *
	 * @param game CreateGame DTO that carries necessary data. Comes form HTTP body.
	 * @return ResponseEntity for REST communication(status 200 if successful, else
	 *         status 403).
	 */
	@PostMapping(&quot;&quot;)
	public ResponseEntity&lt;Integer&gt; createGame(@RequestBody final CreateGame game) {

<span class="fc" id="L55">        Category gameCategory = categoryRepository.findFirstById((long) game.getCategory_id());</span>
<span class="pc bpc" id="L56" title="1 of 4 branches missed.">        if (gameCategory == null || !gameCreationParametersInBounds(game)) {</span>
<span class="fc" id="L57">            return new ResponseEntity&lt;Integer&gt;(HttpStatus.BAD_REQUEST);</span>
        }
        try {
            Game newGame;
<span class="pc bpc" id="L61" title="1 of 2 branches missed.">            if (game.getMapping() == null) {</span>
<span class="fc" id="L62">                newGame = lobbyService.createGame(game.getMax_score(), game.getNumber_of_teams(), gameCategory,</span>
<span class="fc" id="L63">                    game.getDice_code());</span>
            } else {
<span class="nc" id="L65">                newGame = lobbyService.createGame(game.getMax_score(), game.getNumber_of_teams(), gameCategory,</span>
<span class="nc" id="L66">                    buildDice(game), game.getDice_code());</span>
            }

<span class="fc" id="L69">            return new ResponseEntity&lt;Integer&gt;(newGame.getGameCode(), HttpStatus.CREATED);</span>

<span class="fc" id="L71">        } catch (at.qe.timeguess.services.RaspberryService.RaspberryAlreadyInUseException e) {</span>
<span class="fc" id="L72">            return new ResponseEntity&lt;Integer&gt;(HttpStatus.FORBIDDEN);</span>
<span class="nc" id="L73">        } catch (GameCreationException e) {</span>
<span class="nc" id="L74">            return new ResponseEntity&lt;Integer&gt;(HttpStatus.BAD_REQUEST);</span>
<span class="fc" id="L75">        } catch (RaspberryNotFoundException e) {</span>
<span class="fc" id="L76">            return new ResponseEntity&lt;Integer&gt;(HttpStatus.NOT_FOUND);</span>
        }
	}

	/**
	 * Method to fetch all currently running games as an AllGameDTO via REST.
	 *
	 * @return ResponseEntity for REST communication(status 200 if successful).
	 */
	@GetMapping(&quot;&quot;)
	public ResponseEntity&lt;List&lt;GameDTO&gt;&gt; getAllRunningGames() {
<span class="fc" id="L87">        Collection&lt;Game&gt; runningGames = lobbyService.getAllRunningGames();</span>
<span class="fc" id="L88">        List&lt;GameDTO&gt; gameDTOs = new LinkedList&lt;&gt;();</span>
<span class="fc bfc" id="L89" title="All 2 branches covered.">        for (Game g : runningGames) {</span>
<span class="fc" id="L90">            gameDTOs.add(buildGameDTO(g));</span>
<span class="fc" id="L91">        }</span>
<span class="fc" id="L92">        return new ResponseEntity&lt;&gt;(gameDTOs, HttpStatus.OK);</span>
    }

	/**
	 * Method to fetch one currently running game by its gamecode as a GameDTO. Code
	 * comes from URL.
	 *
	 * @param code code of the game to fetch.
	 * @return ResponseEntity for REST communication(status 200 if successful, 404
	 *         if game does not exist).
	 */
	@GetMapping(&quot;/{code}&quot;)
	public ResponseEntity&lt;GameDTO&gt; getGameInfo(@PathVariable final int code) {
<span class="fc" id="L105">		Game game = lobbyService.getGame(code);</span>
<span class="fc bfc" id="L106" title="All 2 branches covered.">		if (game != null) {</span>

<span class="fc" id="L108">			return new ResponseEntity&lt;GameDTO&gt;(buildGameDTO(game), HttpStatus.OK);</span>
		} else {
<span class="fc" id="L110">			return new ResponseEntity&lt;GameDTO&gt;(HttpStatus.NOT_FOUND);</span>
		}

	}

	/**
	 * Method that forcefully closes a game via HTTP request.
	 *
	 * @param code the code of the game to close. Comes from the URL.
	 * @return ResponseEntity for REST communication(status 200 if successful, 404
	 *         if game does not exist).
	 */
	@PreAuthorize(&quot;hasAuthority('ADMIN')&quot;)
	@DeleteMapping(&quot;/{code}&quot;)
	public ResponseEntity&lt;Void&gt; forceCloseRunningGame(@PathVariable final int code) {
<span class="fc bfc" id="L125" title="All 2 branches covered.">		if (lobbyService.getGame(code) == null) {</span>
<span class="fc" id="L126">			return new ResponseEntity&lt;Void&gt;(HttpStatus.NOT_FOUND);</span>
		} else {
<span class="fc" id="L128">			lobbyService.abortRunningGame(code);</span>
<span class="fc" id="L129">			return new ResponseEntity&lt;Void&gt;(HttpStatus.OK);</span>
		}
	}

	@PostMapping(&quot;/{code}/join&quot;)
	public ResponseEntity&lt;Void&gt; joinGame(@PathVariable final int code) {

<span class="nc" id="L136">		User authUser = userService.getAuthenticatedUser();</span>

<span class="nc bnc" id="L138" title="All 2 branches missed.">		if (lobbyService.getGameContainingUser(authUser) != null</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">				&amp;&amp; lobbyService.getGameContainingUser(authUser) != lobbyService.getGame(code)) {</span>
<span class="nc" id="L140">			return new ResponseEntity&lt;&gt;(HttpStatus.CONFLICT);</span>
		}

		try {
<span class="nc" id="L144">			lobbyService.joinGame(code, authUser);</span>
<span class="nc" id="L145">			return new ResponseEntity&lt;&gt;(HttpStatus.OK);</span>
<span class="nc" id="L146">		} catch (GameNotFoundException e) {</span>
<span class="nc" id="L147">			return new ResponseEntity&lt;&gt;(HttpStatus.NOT_FOUND);</span>
<span class="nc" id="L148">		} catch (GameAlreadyRunningException e) {</span>
<span class="nc" id="L149">			return new ResponseEntity&lt;&gt;(HttpStatus.BAD_REQUEST);</span>
		}
	}

	@GetMapping(&quot;/{code}/exists&quot;)
	public ResponseEntity&lt;Void&gt; gameExists(@PathVariable final int code) {

<span class="nc bnc" id="L156" title="All 2 branches missed.">		if (lobbyService.getGame(code) != null) {</span>
<span class="nc" id="L157">			return new ResponseEntity&lt;&gt;(HttpStatus.NO_CONTENT);</span>
		} else {
<span class="nc" id="L159">			return new ResponseEntity&lt;&gt;(HttpStatus.NOT_FOUND);</span>
		}
	}

	/**
	 * Private method to build a GameDTO from a game.
	 *
	 * @param game the game to build the DTO from.
	 * @return the corresponding DTO
	 */
	private GameDTO buildGameDTO(final Game game) {
<span class="fc" id="L170">		List&lt;TeamDTO&gt; teams = new LinkedList&lt;TeamDTO&gt;();</span>
<span class="fc bfc" id="L171" title="All 2 branches covered.">		for (Team t : game.getTeams()) {</span>
<span class="fc" id="L172">			List&lt;UserDTO&gt; users = new LinkedList&lt;UserDTO&gt;();</span>
<span class="pc bpc" id="L173" title="1 of 2 branches missed.">			for (User u : t.getPlayers()) {</span>
<span class="nc" id="L174">				users.add(buildUserDTO(u));</span>
<span class="nc" id="L175">			}</span>
<span class="fc" id="L176">			teams.add(new TeamDTO(t.getName(), t.getScore(), users, t.getIndex()));</span>
<span class="fc" id="L177">		}</span>
<span class="fc" id="L178">		return new GameDTO(game.getGameCode(), teams, buildUserDTO(game.getHost()), game.getCategory(),</span>
<span class="fc" id="L179">				game.getMaxPoints());</span>
	}

	/**
	 * Private method to build a Dice from a Mapping DTO.
	 *
	 * @param game CreateGame DTO which contains the MappingDTO
	 * @return corresponding Dice.
	 */
	private Dice buildDice(final CreateGame game) {
<span class="nc" id="L189">        int[] pointsMapping = new int[12];</span>
<span class="nc" id="L190">        int[] durationMapping = new int[12];</span>
<span class="nc" id="L191">        String[] activityMapping = new String[12];</span>

<span class="nc bnc" id="L193" title="All 2 branches missed.">        for (int i = 0; i &lt; 12; i++) {</span>
<span class="nc" id="L194">            pointsMapping[i] = game.getMapping()[i].getPoints();</span>
<span class="nc" id="L195">            durationMapping[i] = game.getMapping()[i].getTime();</span>
<span class="nc" id="L196">            activityMapping[i] = game.getMapping()[i].getAction();</span>
        }

<span class="nc" id="L199">        return new Dice(pointsMapping, activityMapping, durationMapping);</span>
    }

    /**
     * Private method that builds a UserDTO from a User.
     *
     * @param user user to build DTO from
     * @return corresponding UserDTO
     */
    private UserDTO buildUserDTO(final User user) {
<span class="pc bpc" id="L209" title="1 of 2 branches missed.">        if (user == null) {</span>
<span class="nc" id="L210">            return null;</span>
        } else {
<span class="fc" id="L212">            return new UserDTO(user.getId(), user.getUsername(), user.getRole().toString().toLowerCase());</span>
        }

    }

    /**
     * Method that checks whether the numerical parameters for a game creation are in bounds
     *
     * @param createGame createGameDTO that contains the information for the new game.
     * @return true if all params are in bound, else false
     */
    private boolean gameCreationParametersInBounds(CreateGame createGame) {
<span class="fc" id="L224">        final int gameScoreCeiling = 10000;</span>
<span class="fc" id="L225">        final int teamCeiling = 10;</span>
<span class="fc" id="L226">        final int guessTimeCeiling = 600;</span>
<span class="fc" id="L227">        final int guessScoreCeiling = 100;</span>

<span class="pc bpc" id="L229" title="1 of 4 branches missed.">        if (createGame.getNumber_of_teams() &gt; teamCeiling || createGame.getNumber_of_teams() &lt;= 1 ||</span>
<span class="pc bpc" id="L230" title="2 of 4 branches missed.">            createGame.getMax_score() &gt; gameScoreCeiling || createGame.getMax_score() &lt;= 0) {</span>
<span class="fc" id="L231">            return false;</span>
        }
<span class="pc bpc" id="L233" title="1 of 2 branches missed.">        if (createGame.getMapping() != null) {</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">            for (Mapping mapping : createGame.getMapping()) {</span>
<span class="nc bnc" id="L235" title="All 4 branches missed.">                if (mapping.getTime() &gt; guessTimeCeiling || mapping.getTime() &lt;= 0</span>
<span class="nc bnc" id="L236" title="All 4 branches missed.">                    || mapping.getPoints() &gt; guessScoreCeiling || mapping.getPoints() &lt;= 0) {</span>
<span class="nc" id="L237">                    return false;</span>
                }
            }
        }

<span class="fc" id="L242">        return true;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>