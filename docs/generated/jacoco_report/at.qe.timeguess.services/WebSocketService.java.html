<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WebSocketService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">TimeGuess</a> &gt; <a href="index.source.html" class="el_package">at.qe.timeguess.services</a> &gt; <span class="el_source">WebSocketService.java</span></div><h1>WebSocketService.java</h1><pre class="source lang-java linenums">package at.qe.timeguess.services;

import at.qe.timeguess.dto.TeamDTO;
import at.qe.timeguess.gamelogic.Game;
import at.qe.timeguess.model.User;
import at.qe.timeguess.websockDto.*;
import com.auth0.jwt.interfaces.Claim;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.event.EventListener;
import org.springframework.messaging.simp.SimpMessageHeaderAccessor;
import org.springframework.messaging.simp.SimpMessagingTemplate;
import org.springframework.messaging.simp.stomp.StompHeaderAccessor;
import org.springframework.messaging.support.GenericMessage;
import org.springframework.security.authentication.AuthenticationServiceException;
import org.springframework.stereotype.Controller;
import org.springframework.web.socket.CloseStatus;
import org.springframework.web.socket.WebSocketSession;
import org.springframework.web.socket.messaging.SessionConnectedEvent;
import org.springframework.web.socket.messaging.SessionDisconnectEvent;

import java.io.IOException;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

@Controller
<span class="fc" id="L27">public class WebSocketService {</span>

    @Autowired
    private SimpMessagingTemplate simpMessagingTemplate;

    @Autowired
    private AuthenticationService authenticationService;

    @Autowired
    private UserService userService;

    @Autowired
    private LobbyService lobbyService;

    private static final String INGAMEQUEUE = &quot;/messagequeue/ingame/&quot;;

    private static final String TEAMQUEUE = &quot;/messagequeue/ingame/team/&quot;;

<span class="fc" id="L45">    private final Map&lt;String, User&gt; websocketUserMapping = new HashMap&lt;&gt;();</span>
<span class="fc" id="L46">    private final Map&lt;String, WebSocketSession&gt; websocketSessionMapping = new HashMap&lt;&gt;();</span>

    public void addSession(WebSocketSession session) {
<span class="nc" id="L49">        websocketSessionMapping.put(session.getId(), session);</span>
<span class="nc" id="L50">    }</span>

    public void removeSession(String sessionId) {
<span class="nc" id="L53">        websocketSessionMapping.remove(sessionId);</span>
<span class="nc" id="L54">    }</span>

    /**
     * Method that updates the waitingData in frontend.
     *
     * @param id      the gamecode
     * @param content waitingDataDTO
     */
    public void sendWaitingDataToFrontend(final int id, final WaitingDataDTO content) {
<span class="fc" id="L63">        simpMessagingTemplate.convertAndSend(INGAMEQUEUE + id, new ResponseDTO(&quot;READY_UPDATE&quot;, content));</span>
<span class="fc" id="L64">    }</span>

    /**
     * Method that notifies content that the game is not continuable.
     *
     * @param id the gamecode
     */
    public void sendGameNotContinuableToFrontend(final int id) {
<span class="fc" id="L72">        simpMessagingTemplate.convertAndSend(INGAMEQUEUE + id, new ResponseDTO(&quot;GAME_NOT_CONTINUEABLE&quot;, null));</span>
<span class="fc" id="L73">    }</span>

    /**
     * Method that updates team related information in frontend.
     *
     * @param id    the gamecode
     * @param teams List of teamDTOs to update frontend with.
     */
    public void sendTeamUpdateToFrontend(final int id, final List&lt;TeamDTO&gt; teams) {
<span class="fc" id="L82">        simpMessagingTemplate.convertAndSend(INGAMEQUEUE + id,</span>
            new ResponseDTO(&quot;TEAM_UPDATE&quot;, new TeamResponseDTO(teams)));
<span class="fc" id="L84">    }</span>

    /**
     * Method that sends runningData information to a given team in a given game.
     *
     * @param id        gamecode
     * @param teamIndex index of the team in game
     * @param content   RunningDataDTO containgn updates
     */
    public void sendRunningDataToTeam(final int id, final int teamIndex, final RunningDataDTO content) {
<span class="fc" id="L94">        simpMessagingTemplate.convertAndSend(TEAMQUEUE + id + &quot;/&quot; + teamIndex,</span>
            new ResponseDTO(&quot;RUNNING_DATA&quot;, content));
<span class="fc" id="L96">    }</span>

    /**
     * Method that sends scoreChanges to frontend
     *
     * @param id     the gamecode
     * @param update ScoreUpdateDTO
     */
    public void sendScoreChangeToFrontend(final int id, final ScoreUpdateDTO update) {
<span class="fc" id="L105">        simpMessagingTemplate.convertAndSend(INGAMEQUEUE + id, new ResponseDTO(&quot;SCORE_UPDATE&quot;, update));</span>
<span class="fc" id="L106">    }</span>

    /**
     * Method that sends BatteryUpdates to frontend
     *
     * @param id     the gamecode
     * @param update BatteryUpdateDTO
     */
    public void sendBatteryUpdateToFrontend(final int id, final BatteryUpdateDTO update) {
<span class="fc" id="L115">        simpMessagingTemplate.convertAndSend(INGAMEQUEUE + id, new ResponseDTO(&quot;BAT_UPDATE&quot;, update));</span>
<span class="fc" id="L116">    }</span>

    /**
     * Method that sends Dice-Raspberry connection updates to frontend.
     *
     * @param id     the gamecode
     * @param update DiceConnectionUpdateDTO
     */
    public void sendConnectionUpdateToFrontend(final int id, final DiceConnectionUpdateDTO update) {
<span class="fc" id="L125">        simpMessagingTemplate.convertAndSend(INGAMEQUEUE + id, new ResponseDTO(&quot;CONN_UPDATE&quot;, update));</span>
<span class="fc" id="L126">    }</span>

    /**
     * Method that sends finished game information to frontend. Distinguish between
     * early finishes due to lack of expressions and regular finishes
     *
     * @param id          the gamecode
     * @param content     FinishedGameDTO
     * @param earlyFinish true when game finished early, else false
     */
    public void sendFinishGameToFrontend(final int id, final FinishedGameDTO content, final boolean earlyFinish) {
<span class="nc bnc" id="L137" title="All 2 branches missed.">        if (earlyFinish) {</span>
<span class="nc" id="L138">            simpMessagingTemplate.convertAndSend(INGAMEQUEUE + id, new ResponseDTO(&quot;EARLY_FINISH&quot;, content));</span>
        } else {
<span class="nc" id="L140">            simpMessagingTemplate.convertAndSend(INGAMEQUEUE + id, new ResponseDTO(&quot;REGULAR_FINISH&quot;, content));</span>
        }
<span class="nc" id="L142">    }</span>

    /**
     * Method that sends complete game information to frontend
     *
     * @param id     the gamecode
     * @param update all available information of the game.
     */
    public void sendCompleteGameUpdateToFrontend(final int id, final StateUpdateDTO update) {
<span class="fc" id="L151">        simpMessagingTemplate.convertAndSend(INGAMEQUEUE + id, new ResponseDTO(&quot;FULL_INFO&quot;, update));</span>
<span class="fc" id="L152">    }</span>

    @EventListener
    public void onDisconnectEvent(final SessionDisconnectEvent event) {
<span class="nc" id="L156">        User u = websocketUserMapping.get(event.getSessionId());</span>
        Game game;

<span class="nc bnc" id="L159" title="All 4 branches missed.">        if (u != null &amp;&amp; (game = this.lobbyService.getGameContainingUser(u)) != null) {</span>
<span class="nc" id="L160">            new Thread(() -&gt; {</span>
                try {
<span class="nc" id="L162">                    Thread.sleep(2000);</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">                    if (!websocketUserMapping.containsValue(u)) {</span>
<span class="nc" id="L164">                        game.leaveGame(u);</span>
                    }
<span class="nc" id="L166">                } catch (InterruptedException ignored) {</span>
<span class="nc" id="L167">                }</span>
<span class="nc" id="L168">            }).start();</span>
        }

<span class="nc" id="L171">        this.websocketUserMapping.remove(event.getSessionId());</span>
<span class="nc" id="L172">    }</span>

    @EventListener
    public void onConnectedEvent(final SessionConnectedEvent event) {
<span class="nc" id="L176">        String sessionId = null;</span>

        try {
<span class="nc" id="L179">            StompHeaderAccessor accessor = StompHeaderAccessor.wrap(event.getMessage());</span>
<span class="nc" id="L180">            sessionId = accessor.getMessageHeaders().get(SimpMessageHeaderAccessor.SESSION_ID_HEADER, String.class);</span>
<span class="nc" id="L181">            GenericMessage&lt;?&gt; generic = (GenericMessage&lt;?&gt;) accessor.getHeader(SimpMessageHeaderAccessor.CONNECT_MESSAGE_HEADER);</span>
<span class="nc" id="L182">            SimpMessageHeaderAccessor nativeAccessor = SimpMessageHeaderAccessor.wrap(generic);</span>
<span class="nc" id="L183">            List&lt;String&gt; tokenValue = nativeAccessor.getNativeHeader(&quot;token&quot;);</span>

<span class="nc bnc" id="L185" title="All 2 branches missed.">            if (tokenValue == null) {</span>
<span class="nc" id="L186">                throw new NullPointerException(&quot;Token is null&quot;);</span>
            }

<span class="nc" id="L189">            String jwtToken = tokenValue.stream().findFirst().orElse(null);</span>

<span class="nc" id="L191">            Claim idClaim = null;</span>

            // Removing Bearer from token
<span class="nc bnc" id="L194" title="All 4 branches missed.">            if (jwtToken != null &amp;&amp; jwtToken.startsWith(&quot;Bearer&quot;)) {</span>
<span class="nc" id="L195">                jwtToken = jwtToken.substring(7);</span>
<span class="nc" id="L196">                idClaim = authenticationService.getClaimFromToken(jwtToken, &quot;user_id&quot;);</span>
            }

            //Validate token and set authentication if valid
<span class="nc bnc" id="L200" title="All 2 branches missed.">            if (idClaim != null) {</span>
<span class="nc" id="L201">                Long id = idClaim.asLong();</span>
<span class="nc" id="L202">                User user = this.userService.getUserById(id);</span>

<span class="nc bnc" id="L204" title="All 2 branches missed.">                if (authenticationService.validateToken(jwtToken, user)) {</span>
<span class="nc" id="L205">                    this.websocketUserMapping.put(sessionId, user);</span>

<span class="nc" id="L207">                    this.lobbyService.getGameContainingUser(user).joinGame(user);</span>

<span class="nc" id="L209">                    return;</span>
                }
            }

<span class="nc" id="L213">            throw new AuthenticationServiceException(&quot;Bad authentication&quot;);</span>
<span class="nc" id="L214">        } catch (Exception e) {</span>
            try {
<span class="nc" id="L216">                this.websocketSessionMapping.get(sessionId).close(CloseStatus.NOT_ACCEPTABLE);</span>
<span class="nc" id="L217">            } catch (IOException ignored) {</span>
<span class="nc" id="L218">            }</span>
        }
<span class="nc" id="L220">    }</span>

    public void setWebsocketControllerForGame(final Game game) {
<span class="fc" id="L223">        game.setWebSocketController(this);</span>
<span class="fc" id="L224">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>